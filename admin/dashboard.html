<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel Geral Administrativo | FamÃ­lias Church</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Smooch+Sans:wght@700&display=swap"
        rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        // FunÃ§Ã£o de bloqueio imediato
        function verificarAcessoAdmin() {
            const user = netlifyIdentity.currentUser();

            // 1. Se nÃ£o houver usuÃ¡rio logado, expulsa imediatamente
            if (!user) {
                console.warn("Acesso negado: UsuÃ¡rio nÃ£o autenticado.");
                window.location.href = "../index.html";
                return;
            }

            const meta = user.user_metadata;
            const appMeta = user.app_metadata;

            // Normaliza o cargo para evitar erros de acentuaÃ§Ã£o ou maiÃºsculas
            const cargo = (meta.cargo || "").toLowerCase();
            const roles = appMeta.roles || [];

            // 2. CritÃ©rios de PermissÃ£o (Apenas Financeiro ou ApÃ³stolo)
            const temAcesso =
                cargo === "financeiro" ||
                cargo === "apÃ³stolo" ||
                cargo === "apostolo" ||
                roles.includes("financeiro");

            if (!temAcesso) {
                alert("âš ï¸ Acesso Restrito: Esta Ã¡rea Ã© exclusiva para a administraÃ§Ã£o.");
                window.location.href = "../perfil.html"; // Manda para o perfil comum
            }
        }

        // Executa assim que o widget terminar de carregar as configuraÃ§Ãµes
        netlifyIdentity.on('init', user => {
            verificarAcessoAdmin();
        });

        // Caso o status de login mude enquanto a pÃ¡gina estÃ¡ aberta
        netlifyIdentity.on('logout', () => {
            window.location.href = "../index.html";
        });
    </script>
</head>

<body style="background: #f4f6f5;">
    <header id="header"></header>

    <main class="container" style="margin-top: 130px; min-height: 80vh;">
        <div class="perfil-section">
            <h1 class="titulo-secao">Centro de Comando</h1>
            <p>VisÃ£o geral das atividades que aguardam moderaÃ§Ã£o.</p>

            <div class="dashboard-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">

                <div class="card-admin" onclick="window.location.href='financeiro.html'">
                    <div class="icon-admin">ğŸ•Šï¸</div>
                    <h3>Financeiro</h3>
                    <p><span id="count-dizimos" class="badge-count-admin">0</span> DÃ­zimos Pendentes</p>
                    <button class="btn-hero" style="font-size: 0.7rem; margin-top: 15px;">Gerenciar</button>
                    <div class="card-admin">
                        <div class="icon-admin">ğŸ•Šï¸</div>
                        <div class="card-admin" style="border-color: #333;">
                            <div class="icon-admin">ğŸ’¾</div>
                            <h3>Sistema</h3>
                            <p>Backup de SeguranÃ§a</p>
                            <button id="btnBackup" class="btn-hero"
                                style="font-size: 0.7rem; margin-top: 15px; background: #333;"
                                onclick="executarBackup()">
                                ğŸ“¦ Baixar Backup Total
                            </button>
                        </div>
                        <h3>Financeiro</h3>
                        <p><span id="count-dizimos" class="badge-count-admin">0</span> DÃ­zimos Pendentes</p>
                        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                            <button class="btn-hero" style="font-size: 0.7rem;"
                                onclick="window.location.href='financeiro.html'">Gerenciar</button>
                            <button class="btn-hero" style="font-size: 0.7rem; background: #217346;"
                                onclick="exportarRelatorioCSV()">ğŸ“Š Exportar Excel</button>
                        </div>
                    </div>
                </div>

                <div class="card-admin" onclick="window.location.href='moderacao.html'">
                    <div class="icon-admin">ğŸ“¢</div>
                    <h3>Testemunhos</h3>
                    <p><span id="count-testemunhos" class="badge-count-admin">0</span> Para Aprovar</p>
                    <button class="btn-hero" style="font-size: 0.7rem; margin-top: 15px;">Moderar</button>
                </div>

                <div class="card-admin" onclick="window.location.href='../perfil.html'">
                    <div class="icon-admin">ğŸ™</div>
                    <h3>OraÃ§Ãµes</h3>
                    <p><span id="count-oracoes" class="badge-count-admin">0</span> Novos Pedidos</p>
                    <button class="btn-hero" style="font-size: 0.7rem; margin-top: 15px;">Ver Pedidos</button>
                </div>

            </div>
        </div>
    </main>

    <footer id="footer" class="footer-moderno"></footer>

    <script src="../script.js"></script>
    <script>
        // SEGURANÃ‡A POR PAPEL: Apenas 'moderador'
        netlifyIdentity.on("init", user => validarAcesso(user));
        netlifyIdentity.on("login", user => {
            const meta = user.user_metadata;
            const cargo = (meta.cargo || "membro").toLowerCase();
            
            // RestriÃ§Ã£o especÃ­fica: Apenas o Financeiro e o ApÃ³stolo tÃªm acesso ao painel admin
            const cargosAutorizados = ["financeiro", "apÃ³stolo", "apostolo"];

            if (cargosAutorizados.includes(cargo)) {
                // Redireciona para o painel administrativo da igreja
                window.location.href = './admin/index.html';
            } else {
                // Demais membros e obreiros (pastores, mÃ­dia, etc.) vÃ£o para o perfil comum
                window.location.href = './perfil.html';
            }
        });

        async function contarPendencias() {
            try {
                // Busca simultÃ¢nea de todos os Ã­ndices para contar pendÃªncias
                const [resFin, resTest, resOrac] = await Promise.all([
                    fetch('/.netlify/functions/listar_todas_contribuicoes'),
                    fetch('/.netlify/functions/listar_todos_testemunhos'),
                    fetch('/.netlify/functions/listar_todas_oracoes')
                ]);

                const dizimos = await resFin.json();
                const testemunhos = await resTest.json();
                const oracoes = await resOrac.json();

                // Filtra apenas o que estÃ¡ com status 'Pendente' ou 'NÃ£o lido'
                document.getElementById('count-dizimos').innerText = dizimos.filter(d => d.status === 'Pendente').length;
                document.getElementById('count-testemunhos').innerText = testemunhos.filter(t => t.status === 'Pendente').length;
                document.getElementById('count-oracoes').innerText = oracoes.filter(o => o.status !== 'Lida').length;

            } catch (err) { console.error("Erro ao carregar contadores", err); }
        }
        async function exportarRelatorioCSV() {
            try {
                const res = await fetch('/.netlify/functions/listar_todas_contribuicoes');
                const dados = await res.json();

                // Filtra apenas os confirmados do mÃªs atual
                const agora = new Date();
                const confirmados = dados.filter(c => {
                    const dataC = new Date(c.data);
                    return c.status === "Confirmado" &&
                        dataC.getMonth() === agora.getMonth() &&
                        dataC.getFullYear() === agora.getFullYear();
                });

                if (confirmados.length === 0) {
                    alert("NÃ£o existem dÃ­zimos confirmados para exportar este mÃªs.");
                    return;
                }

                // CabeÃ§alho do CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Data;Nome;Valor;Status;ID\n";

                // Adiciona as linhas
                confirmados.forEach(c => {
                    const linha = `${new Date(c.data).toLocaleDateString('pt-BR')};${c.nome};${c.valor};${c.status};${c.id || ''}`;
                    csvContent += linha + "\n";
                });

                // Trigger do Download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_financeiro_${agora.getMonth() + 1}_${agora.getFullYear()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                alert("Erro ao gerar relatÃ³rio: " + err.message);
            }
        }
        async function executarBackup() {
            const btn = document.getElementById('btnBackup');
            const originalText = btn.innerText;

            try {
                btn.innerText = "â³ Gerando pacote...";
                btn.disabled = true;

                const res = await fetch('/.netlify/functions/gerar_backup');
                const dados = await res.json();

                // Converte o objeto de backup em um Blob para download
                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);

                const a = document.createElement('a');
                const dataStr = new Date().toISOString().split('T')[0];

                a.href = url;
                a.download = `backup_familias_church_${dataStr}.json`;
                document.body.appendChild(a);
                a.click();

                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                btn.innerText = "âœ… Backup ConcluÃ­do!";
            } catch (err) {
                alert("Erro ao gerar backup: " + err.message);
                btn.innerText = originalText;
            } finally {
                btn.disabled = false;
                setTimeout(() => { btn.innerText = originalText; }, 3000);
            }
        }
    </script>
</body>

</html>