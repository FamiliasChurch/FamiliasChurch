<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Portal do Obreiro | Fam√≠lias Church</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Smooch+Sans:wght@700&display=swap" rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
    <header id="header"></header>

    <main class="container" style="margin-top: 130px; min-height: 70vh;">
        <div id="login-section" class="form-container">
            <h2 class="titulo-secao" style="border: none; text-align: center;">Acesso do Obreiro</h2>
            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button onclick="netlifyIdentity.open()" class="btn-enviar" style="width: auto; padding: 10px 30px;">Entrar com e-mail da Igreja</button>
            </div>
        </div>

        <div id="admin-section" class="form-container hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="boas-vindas" style="color: var(--cor-primaria); margin: 0;"></h2>
                <button onclick="netlifyIdentity.logout()" style="background:none; border:none; cursor:pointer; text-decoration:underline;">Sair</button>
            </div>

            <form id="formConteudo">
                <label>O que deseja publicar?</label>
                <select id="tipo" onchange="alternarCamposEvento()" required>
                    <option value="devocionais">Devocional</option>
                    <option value="estudos">Estudo B√≠blico</option>
                    <option value="eventos">Evento / Culto Especial</option>
                </select>

                <div id="campos-evento" class="hidden" style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <label>Data do Evento</label>
                    <input type="datetime-local" id="data_evento">
                    <label>URL da Imagem (Ex: assets/img/upload/banner.jpg)</label>
                    <input type="text" id="imagem_evento" placeholder="Cole o caminho da imagem" oninput="atualizarPreview()">

                    <div id="preview-container" class="hidden" style="margin: 15px 0; text-align: center;">
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üëÄ Pr√©-visualiza√ß√£o da Capa:</p>
                        <img id="preview-img" src="" alt="Preview" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid var(--cor-primaria);">
                    </div>
                    <label style="display:flex; align-items:center; gap:10px;"><input type="checkbox" id="is_special"> Encontro com Deus (Destaque)?</label>
                </div>

                <input type="text" id="titulo" placeholder="T√≠tulo" required>
                <textarea id="texto" placeholder="Conte√∫do (Markdown)..." rows="10" required></textarea>
                <button type="submit" class="btn-enviar">üöÄ Publicar e Atualizar Site</button>
            </form>
            <p id="status" style="margin-top: 20px; font-weight: bold; text-align: center;"></p>
        </div>
    </main>

    <footer id="footer" class="footer-moderno"></footer>

    <script>
        let autorLogado = "";

        // L√≥gica de Controle de Acesso e Login
        netlifyIdentity.on('login', user => {
            const meta = user.user_metadata;
            const cargo = (meta.cargo || "Membro").toLowerCase();
            autorLogado = meta.full_name || user.email;

            // REGRA: Se for M√≠dia, s√≥ pode ver 'eventos'
            if (cargo === "m√≠dia" || cargo === "midia") {
                const selectTipo = document.getElementById('tipo');
                selectTipo.value = 'eventos';
                // Remove as outras op√ß√µes para o M√≠dia n√£o mudar
                Array.from(selectTipo.options).forEach(opt => {
                    if (opt.value !== 'eventos') opt.remove();
                });
                alternarCamposEvento(); // Mostra os campos de data
            } 
            // Se n√£o for Pastor/Ap√≥stolo, expulsa da p√°gina
            else if (cargo !== "pastor" && cargo !== "ap√≥stolo") {
                alert("Acesso restrito aos Obreiros.");
                window.location.href = "../index.html";
                return;
            }

            // Se chegou aqui, tem acesso
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('boas-vindas').innerText = `A Paz, ${autorLogado}!`;
            netlifyIdentity.close();
        });

        netlifyIdentity.on('logout', () => location.reload());

        // Fun√ß√µes de Interface
        function alternarCamposEvento() {
            document.getElementById('campos-evento').classList.toggle('hidden', document.getElementById('tipo').value !== 'eventos');
        }

        function atualizarPreview() {
            const url = document.getElementById('imagem_evento').value;
            const previewContainer = document.getElementById('preview-container');
            const previewImg = document.getElementById('preview-img');
            if (url.trim() !== "") {
                previewImg.src = url;
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }
        }

        // Envio do Formul√°rio (Sua l√≥gica original)
        document.getElementById('formConteudo').onsubmit = async function (e) {
            e.preventDefault();
            const status = document.getElementById('status');
            const tipoSel = document.getElementById('tipo').value;
            status.innerText = "‚è≥ Publicando e gerando √≠ndices...";

            const payload = {
                title: document.getElementById('titulo').value,
                body: document.getElementById('texto').value,
                autor: autorLogado,
                date: new Date().toISOString()
            };

            let pathFinal = "";
            if (tipoSel === 'eventos') {
                payload.date = document.getElementById('data_evento').value;
                payload.image = document.getElementById('imagem_evento').value || "assets/img/logo.jpg";
                payload.is_special = document.getElementById('is_special').checked;
                pathFinal = `content/eventos/${Date.now()}-evento.json`;
            } else {
                payload.tipo = tipoSel === 'devocionais' ? 'devocional' : 'estudo';
                pathFinal = `content/publicacoes/${tipoSel}/${Date.now()}-post.json`;
            }

            try {
                const res = await fetch('/.netlify/functions/publicar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload, path: pathFinal, folder: tipoSel === 'eventos' ? 'eventos' : `publicacoes/${tipoSel}` })
                });

                if (res.ok) {
                    status.innerHTML = "‚úÖ Sucesso! O site foi atualizado.";
                    setTimeout(() => { window.location.href = 'obrigado-publicacao.html'; }, 1500);
                }
            } catch (err) { status.innerHTML = "‚ùå Erro: " + err.message; }
        };
    </script>
</body>
</html>