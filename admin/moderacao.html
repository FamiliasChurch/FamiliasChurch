<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Moderação de Testemunhos | Famílias Church</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        // Função de bloqueio imediato
        function verificarAcessoAdmin() {
            const user = netlifyIdentity.currentUser();

            // 1. Se não houver usuário logado, expulsa imediatamente
            if (!user) {
                console.warn("Acesso negado: Usuário não autenticado.");
                window.location.href = "../index.html";
                return;
            }

            const meta = user.user_metadata;
            const appMeta = user.app_metadata;

            // Normaliza o cargo para evitar erros de acentuação ou maiúsculas
            const cargo = (meta.cargo || "").toLowerCase();
            const roles = appMeta.roles || [];

            // 2. Critérios de Permissão (Apenas Financeiro ou Apóstolo)
            const temAcesso =
                cargo === "financeiro" ||
                cargo === "apóstolo" ||
                cargo === "apostolo" ||
                roles.includes("financeiro");

            if (!temAcesso) {
                alert("⚠️ Acesso Restrito: Esta área é exclusiva para a administração.");
                window.location.href = "../perfil.html"; // Manda para o perfil comum
            }
        }

        // Executa assim que o widget terminar de carregar as configurações
        netlifyIdentity.on('init', user => {
            verificarAcessoAdmin();
        });

        // Caso o status de login mude enquanto a página está aberta
        netlifyIdentity.on('logout', () => {
            window.location.href = "../index.html";
        });
    </script>
</head>
<body style="background: #f4f6f5;">
    <header id="header"></header>

    <main class="container" style="margin-top: 130px; min-height: 80vh;">
        <div class="perfil-section">
            <h1 class="titulo-secao">Central de Moderação</h1>
            <p>Aprove ou remova testemunhos enviados pelos membros.</p>

            <div id="lista-moderacao" class="grid-testemunhos" style="margin-top: 30px;">
                <p class="aviso-vazio">Buscando novos testemunhos...</p>
            </div>
        </div>
    </main>

    <footer id="footer" class="footer-moderno"></footer>

    <script src="../script.js"></script>
    <script>
    // 1. Inicialização e Proteção de Rota
    netlifyIdentity.on("init", user => validarAcesso(user));
    netlifyIdentity.on("login", user => validarAcesso(user));

    function validarAcesso(user) {
        // Verifica se há sessão ativa
        if (!user) {
            alert("Sessão expirada. Faça login novamente.");
            window.location.href = "../index.html";
            return;
        }

        // 2. Verificação Silenciosa (Role interna 'mod')
        // app_metadata não é editável pelo usuário e não aparece no Perfil
        const permissoes = user.app_metadata?.roles || [];
        const eModerador = permissoes.includes("mod");

        if (!eModerador) {
            console.warn("Tentativa de acesso sem a role 'mod'.");
            alert("Acesso negado. Área restrita à equipe de moderação.");
            window.location.href = "../index.html";
        } else {
            // Se tiver a permissão interna 'mod', carrega a lista
            carregarPendentes();
        }
    }

    // 3. Carregamento de Testemunhos Pendentes
    async function carregarPendentes() {
        const container = document.getElementById('lista-moderacao');
        if (!container) return;

        try {
            const res = await fetch(`/.netlify/functions/listar_todos_testemunhos`);
            const lista = await res.json();

            // Filtra apenas o que aguarda aprovação
            const pendentes = lista.filter(t => t.status === "Pendente");

            if (pendentes.length === 0) {
                container.innerHTML = `
                    <div class="aviso-vazio" style="text-align:center; padding: 40px;">
                        <i class="fa-solid fa-check-double" style="font-size: 2rem; color: #2d5a27;"></i>
                        <p style="margin-top:15px;">Tudo limpo! Não há testemunhos para moderar.</p>
                    </div>`;
                return;
            }

            container.innerHTML = pendentes.map(t => `
                <div class="card-testemunho" style="border-left: 5px solid #d4a373; margin-bottom: 20px;">
                    <p class="texto-testemunho">${t.texto}</p>
                    <div class="autor-testemunho">
                        <strong>— ${t.autor}</strong>
                    </div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button class="btn-hero" 
                                style="background: #2d5a27; font-size: 0.75rem; padding: 8px 20px;" 
                                onclick="moderar('${t.id}', 'Aprovado')">✅ Aprovar</button>
                        <button class="btn-hero" 
                                style="background: #ea4335; font-size: 0.75rem; padding: 8px 20px;" 
                                onclick="moderar('${t.id}', 'Recusado')">❌ Recusar</button>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            container.innerHTML = '<p style="color:red; text-align:center;">Erro na conexão com o servidor de moderação.</p>';
        }
    }

    // 4. Execução da Ação de Moderação
    async function moderar(fileId, novoStatus) {
        const acao = novoStatus === 'Aprovado' ? "APROVAR" : "RECUSAR";
        if(!confirm(`Confirma que deseja ${acao} este registro?`)) return;
        
        try {
            const res = await fetch(`/.netlify/functions/moderar_testemunho`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId, novoStatus })
            });

            if(res.ok) {
                alert(`Sucesso! Testemunho ${novoStatus.toLowerCase()}.`);
                carregarPendentes(); // Atualiza a lista automaticamente
            } else {
                throw new Error();
            }
        } catch (err) { 
            alert("Erro ao processar moderação. Verifique sua conexão."); 
        }
    }
</script>
</body>
</html>